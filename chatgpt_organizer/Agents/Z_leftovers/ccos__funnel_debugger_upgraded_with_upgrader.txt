# agents/funnel_debugger.py

"""
Agent Name: funnel_debugger
Role: growth
Version: 1.0.0
Description: Detects leaks or drop-offs in user acquisition and onboarding funnels.
"""

import json
from agents.agent_core import BaseAgent
from core.scheduler import schedule_task
from core.messaging import handle_message
from core.webhooks import register_webhook
from core.training import register_training_example
from core.upgrader import inject
from registry.agent_registry import register_agent
from utils.funnel_tools import run_logic

# Agent Metadata
agent_name = "funnel_debugger"
agent_description = "Detects leaks or drop-offs in user acquisition and onboarding funnels."
agent_role = "growth"
agent_version = "1.0.0"

# Input Schema
expected_input = {
    "funnel_stages": [
        "Visited landing",
        "Signed up",
        "Activated",
        "Upgraded"
    ],
    "conversion_rates": [
        0.5,
        0.2,
        0.05
    ]
}
# Output Schema
output_format = {
    "leak_stage": "Activation",
    "recommendation": "Improve onboarding flow"
}

class FunnelDebugger(BaseAgent):
    def __init__(self):
        super().__init__(
            name=agent_name,
            description=agent_description,
            role=agent_role,
            version=agent_version,
            input_schema=expected_input,
            output_schema=output_format
        )

    def run(self, context):
        try:
            result = run_logic(context)
            self.log("Task completed.")
            return result
        except Exception as e:
            self.error(f"Execution failed: {str(e)}")
            return {"error": str(e)}            

    def auto_schedule(self):
        schedule_task(agent_name, self.run, day_of_week="fri", hour=7)

    def message_hooks(self, message_data):
        if "funnel" in message_data.get("intent", ""):
            return self.run(message_data.get("context", {}))
        return {"status": "ignored"}

    def webhook_handler(self, payload):
        context = payload.get("funnel_context", {})
        return self.run(context)

    def training_data(self):
        examples = [
            {
                "input": {"funnel_stages": ["Visited landing", "Signed up", "Activated", "Upgraded"], "conversion_rates": [0.5, 0.2, 0.05]},
                "output": {"leak_stage": "Activation", "recommendation": "Improve onboarding flow"}
            }
        ]
        for example in examples:
            register_training_example(agent_name, example["input"], example["output"])

# Register
register_agent(FunnelDebugger)

# Dev stub
if __name__ == "__main__":
    bot = inject(FunnelDebugger())
    result = bot.run({"funnel_stages": ["Visited landing", "Signed up", "Activated", "Upgraded"], "conversion_rates": [0.5, 0.2, 0.05]})
    print(json.dumps(result, indent=2))
